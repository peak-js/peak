<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Peak.js Morph Tests</title>
</head>
<body>
  <h1>Morph Test</h1>

  <h2>Text changes</h2>
  <div id="$text">Initial text</div>
  <button onclick="changeText()">Change text</button>

  <hr>

  <h2>Attribute changes</h2>
  <div id="$attr" class="test-class" data-test="initial">Attribute test</div>
  <button onclick="changeAttr()">Change attributes</button>

  <hr>

  <h2>Boolean attributes</h2>
  <input type="checkbox" id="$bool" checked>
  <button onclick="toggleBool()">Toggle checkbox</button>

  <hr>

  <h2>Adding elements</h2>
  <ul id="$grow">
    <li>Item 1</li>
    <li>Item 2</li>
  </ul>
  <button onclick="addItem()">Add item</button>

  <hr>

  <h2>Removing Elements</h2>
  <ul id="$prune">
    <li>Item 1</li>
    <li>Item 2</li>
    <li>Item 3</li>
  </ul>
  <button onclick="removeItem()">Remove item</button>

  <hr>

  <h2>Keyed elements reordering</h2>
  <ul id="$scramble">
    <li key="1">Item 1</li>
    <li key="2">Item 2</li>
    <li key="3">Item 3</li>
  </ul>
  <button onclick="scramble()">Scramble order</button>

  <hr>

  <h2>Cross-hierarchy keyed component movement</h2>
  <div id="$hierarchy">
    <div class="container-a">
      <p>Container A:</p>
      <x-counter key="toolbar"></x-counter>
    </div>
    <div class="container-b">
      <p>Container B:</p>
    </div>
  </div>
  <button onclick="moveToolbar()">Move toolbar</button>

  <hr>

  <h2>Deeply nested keyed component lookup</h2>
  <div id="$nested">
    <div class="level1">
      <div class="level2">
        <div class="level3">
          <x-counter key="deep-widget"></x-counter>
        </div>
      </div>
    </div>
    <div class="different-branch">
      <p>Different branch:</p>
    </div>
  </div>
  <button onclick="moveDeepWidget()">Move deep widget</button>

  <hr>

  <h2>Sibling keyed component movement</h2>
  <div id="$siblings">
    <x-counter key="sibling-widget"></x-counter>
    <div class="spacer">Spacer content</div>
    <div class="target">Target location</div>
  </div>
  <button onclick="moveSibling()">Move to end</button>

  <script type="module">
    import { morph, component } from './peak.js'

    // Load counter component for testing
    await component('x-counter', './components/x-counter.html')

    window.changeText = function() {
      const clone = window.$text.cloneNode(true)
      clone.textContent = 'Updated text'
      morph($text, clone)
    }

    window.changeAttr = function() {
      const clone = window.$attr.cloneNode(true)
      clone.setAttribute('data-test', 'updated')
      clone.classList.remove('test-class')
      clone.classList.add('new-class')
      morph(window.$attr, clone, true)
    }

    window.toggleBool = function() {
      const clone = window.$bool.cloneNode(true)
      if (window.$bool.hasAttribute('checked')) {
        clone.removeAttribute("checked")
      } else {
        clone.setAttribute("checked", "checked")
      }
      morph(window.$bool, clone, true)
    }

    window.addItem = function() {
      const clone = window.$grow.cloneNode(true)
      const newItem = document.createElement('li')
      newItem.textContent = 'Item 3'
      clone.appendChild(newItem)
      morph(window.$grow, clone)
    }

    window.removeItem = function() {
      const clone = window.$prune.cloneNode(true)
      clone.querySelector('li:nth-child(2)').remove()
      morph(window.$prune, clone)
    }

    window.scramble = function() {
      const clone = window.$scramble.cloneNode(true)
      const items = Array.from(clone.querySelectorAll('li'))
      clone.innerHTML = ''
      clone.appendChild(items[2])
      clone.appendChild(items[0])
      clone.appendChild(items[1])
      morph(window.$scramble, clone)
    }

    window.moveToolbar = function() {
      const clone = window.$hierarchy.cloneNode(true)
      const toolbar = clone.querySelector('[key="toolbar"]')
      const containerB = clone.querySelector('.container-b')

      // Move toolbar from container A to container B
      toolbar.remove()
      containerB.appendChild(toolbar)

      morph(window.$hierarchy, clone)
    }

    window.moveDeepWidget = function() {
      const clone = window.$nested.cloneNode(true)
      const widget = clone.querySelector('[key="deep-widget"]')
      const differentBranch = clone.querySelector('.different-branch')

      // Move widget from deep nesting to different branch
      widget.remove()
      differentBranch.appendChild(widget)

      morph(window.$nested, clone)
    }

    window.moveSibling = function() {
      const clone = window.$siblings.cloneNode(true)
      const widget = clone.querySelector('[key="sibling-widget"]')

      // Move widget from first position to last position (still siblings)
      widget.remove()
      clone.appendChild(widget)

      morph(window.$siblings, clone)
    }
  </script>
</body>
</html>
